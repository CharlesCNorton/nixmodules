version: v1.0
name: test
agent:
  machine:
    type: s1-goval
fail_fast:
  stop:
    when: "true"
auto_cancel:
  running:
    when: branch != 'main'
global_job_config:
  env_vars:
    - name: SEMAPHORE_CACHE_BACKEND
      value: "gcs"
    - name: SEMAPHORE_CACHE_GCS_BUCKET
      value: "goval-semaphore-cache"
blocks:
  - name: update prodvana configs
    run:
      when: "branch = 'main' and change_in(['/manifests'], {default_branch: 'main'})"
    task:
      secrets:
        - name: gcp-goval
        - name: ship-it-bot
      jobs:
        - name: update Prodvana manifests
          commands:
            - set -e
            - checkout --use-cache
            - gcloud auth configure-docker --quiet
            - ./scripts/install_prodvana.sh
            - pvnctl config validate manifests
            - pvnctl config apply manifests --no-prompt=true
    dependencies: []
promotions:
- name: build nixmodules
  pipeline_file: build-nixmodules.yml
- name: build instance template
  pipeline_file: build-ci-image.yml

